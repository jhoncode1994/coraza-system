name: Keep Supabase Database Alive

on:
  schedule:
    # Ejecutar cada 5 d√≠as a las 3:00 AM UTC (evita los 7 d√≠as de inactividad)
    # Formato: minuto hora d√≠a-del-mes mes d√≠a-de-la-semana
    - cron: '0 3 */5 * *'
  
  # Permitir ejecuci√≥n manual desde GitHub Actions
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Ping Supabase Database
        run: |
          echo "üîÑ Enviando ping a Supabase para mantener la base de datos activa..."
          
          # Realizar ping al endpoint keep-alive del servidor
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 30 \
            --retry 3 \
            --retry-delay 5 \
            https://coraza-system-production.up.railway.app/api/keep-alive)
          
          if [ "$response" = "200" ]; then
            echo "‚úÖ Ping exitoso! Base de datos Supabase activa (HTTP $response)"
          else
            echo "‚ö†Ô∏è Respuesta inesperada: HTTP $response"
            echo "‚ÑπÔ∏è Intentando ping alternativo directo a Supabase..."
            
            # Ping alternativo directo a Supabase usando la API REST
            supabase_response=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 30 \
              -H "apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrbnhicGNucGRoemlpcWtucmJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjkyMTAsImV4cCI6MjA3MzAwNTIxMH0.oupKVcJplxy-H88HjeS4-QAaD8ChjyfcaqZDnC-xuIs" \
              -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrbnhicGNucGRoemlpcWtucmJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjkyMTAsImV4cCI6MjA3MzAwNTIxMH0.oupKVcJplxy-H88HjeS4-QAaD8ChjyfcaqZDnC-xuIs" \
              "https://vknxbpcnpdhziiqknrbs.supabase.co/rest/v1/rpc/health")
            
            if [ "$supabase_response" = "200" ] || [ "$supabase_response" = "204" ]; then
              echo "‚úÖ Ping directo a Supabase exitoso (HTTP $supabase_response)"
            else
              echo "‚ö†Ô∏è Ambos m√©todos fallaron, pero el workflow continuar√°"
            fi
          fi
          
          echo "üìÖ Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "üéØ Pr√≥xima ejecuci√≥n programada en 5 d√≠as"
      
      - name: Report Status
        if: always()
        run: |
          echo "üìä Estado del Keep-Alive:"
          echo "   ‚Ä¢ Base de datos: Supabase"
          echo "   ‚Ä¢ Objetivo: Prevenir pausa por inactividad (7 d√≠as)"
          echo "   ‚Ä¢ Frecuencia: Cada 5 d√≠as"
          echo "   ‚Ä¢ M√©todo: Ping HTTP a endpoint + API REST backup"
