name: Keep Supabase Database Alive

on:
  schedule:
    # Ejecutar cada 3 dÃ­as a las 3:00 AM UTC (mÃ¡s frecuente para mayor seguridad)
    # IMPORTANTE: GitHub puede desactivar workflows en repos sin actividad
    - cron: '0 3 */3 * *'
  
  # Permitir ejecuciÃ³n manual desde GitHub Actions
  workflow_dispatch:

# Permisos necesarios para hacer commits automÃ¡ticos
permissions:
  contents: write

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Ping Supabase Database Directly
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ğŸ”„ Enviando ping DIRECTO a Supabase para mantener la base de datos activa..."
          echo "ğŸ“… Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          # Usar las variables de entorno o valores por defecto
          ANON_KEY="${SUPABASE_ANON_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrbnhicGNucGRoemlpcWtucmJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjkyMTAsImV4cCI6MjA3MzAwNTIxMH0.oupKVcJplxy-H88HjeS4-QAaD8ChjyfcaqZDnC-xuIs}"
          DB_URL="${SUPABASE_URL:-https://vknxbpcnpdhziiqknrbs.supabase.co}"
          
          # MÃ©todo 1: Query directa a la base de datos (mÃ¡s confiable)
          echo "ğŸ“Œ MÃ©todo 1: Query directa a Supabase REST API..."
          response=$(curl -s -w "\n%{http_code}" \
            --max-time 60 \
            --retry 5 \
            --retry-delay 10 \
            -H "apikey: $ANON_KEY" \
            -H "Authorization: Bearer $ANON_KEY" \
            -H "Content-Type: application/json" \
            "${DB_URL}/rest/v1/usuarios?select=id&limit=1")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Ping directo a Supabase exitoso (HTTP $http_code)"
            echo "   Respuesta: $body"
          else
            echo "âš ï¸ Primer intento fallÃ³ (HTTP $http_code)"
            
            # MÃ©todo 2: Intentar con otra tabla
            echo "ğŸ“Œ MÃ©todo 2: Intentando con endpoint alternativo..."
            alt_response=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 60 \
              -H "apikey: $ANON_KEY" \
              -H "Authorization: Bearer $ANON_KEY" \
              "${DB_URL}/rest/v1/")
            
            if [ "$alt_response" = "200" ] || [ "$alt_response" = "204" ]; then
              echo "âœ… Ping alternativo exitoso (HTTP $alt_response)"
            else
              echo "âŒ Todos los mÃ©todos fallaron - El proyecto puede estar pausado"
              echo "   Por favor despause el proyecto en: https://supabase.com/dashboard"
            fi
          fi
          
          # MÃ©todo 3: TambiÃ©n intentar despertar el servidor en Render
          echo ""
          echo "ğŸ“Œ MÃ©todo 3: Despertando servidor en Render..."
          render_response=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 120 \
            --retry 2 \
            https://coraza-system.onrender.com/api/keep-alive 2>/dev/null || echo "timeout")
          
          if [ "$render_response" = "200" ]; then
            echo "âœ… Servidor Render activo (HTTP $render_response)"
          else
            echo "â„¹ï¸ Servidor Render: HTTP $render_response (puede estar iniciando)"
          fi
      
      - name: Update Keep-Alive Timestamp
        run: |
          # Crear o actualizar archivo de timestamp para mantener actividad en el repo
          echo "Last keep-alive: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > .github/last-keepalive.txt
          echo "Workflow run: ${{ github.run_number }}" >> .github/last-keepalive.txt
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add .github/last-keepalive.txt
          
          # Solo hacer commit si hay cambios
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No hay cambios para commitear"
          else
            git commit -m "chore: keep-alive ping $(date -u +%Y-%m-%d) [skip ci]"
            git push
            echo "âœ… Commit de keep-alive realizado para mantener el repo activo"
          fi
      
      - name: Report Status
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š RESUMEN DEL KEEP-ALIVE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   â€¢ Base de datos: Supabase (vknxbpcnpdhziiqknrbs)"
          echo "   â€¢ Servidor: Render (coraza-system)"
          echo "   â€¢ Objetivo: Prevenir pausa por inactividad (7 dÃ­as)"
          echo "   â€¢ Frecuencia: Cada 3 dÃ­as"
          echo "   â€¢ MÃ©todo: Query directa a Supabase + commit automÃ¡tico"
          echo ""
          echo "âš ï¸  IMPORTANTE: Si recibes email de pausa, despausar en:"
          echo "    https://supabase.com/dashboard/project/vknxbpcnpdhziiqknrbs"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
