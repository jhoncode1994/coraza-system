<div class="reports-container">
  <div class="reports-header">
    <h1>
      <mat-icon>assessment</mat-icon>
      Gestión de Reportes
    </h1>
  </div>

  <!-- Filtros -->
  <mat-card class="filters-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>filter_list</mat-icon>
        Filtros de Búsqueda
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="filterForm" class="filters-form">
        <div class="filter-row">
          <mat-form-field appearance="outline">
            <mat-label>Fecha Inicio</mat-label>
            <input matInput [matDatepicker]="startPicker" formControlName="startDate">
            <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Fecha Fin</mat-label>
            <input matInput [matDatepicker]="endPicker" formControlName="endDate">
            <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Zona</mat-label>
            <mat-select formControlName="zone">
              <mat-option value="">Todas las zonas</mat-option>
              <mat-option *ngFor="let zone of availableZones" [value]="zone">
                Zona {{ zone }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="filter-row">
          <mat-form-field appearance="outline">
            <mat-label>Artículo</mat-label>
            <mat-select formControlName="supply">
              <mat-option value="">Todos los artículos</mat-option>
              <mat-option *ngFor="let supply of availableSupplies" [value]="supply">
                {{ supply | titlecase }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Empleado</mat-label>
            <input matInput formControlName="employee" placeholder="Nombre, apellido o cédula">
          </mat-form-field>

          <div class="filter-actions">
            <button mat-raised-button color="primary" (click)="applyFilters()" [disabled]="isLoading">
              <mat-icon>search</mat-icon>
              Aplicar Filtros
            </button>
            <button mat-button (click)="clearFilters()" [disabled]="isLoading">
              <mat-icon>clear</mat-icon>
              Limpiar
            </button>
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Tabs de reportes -->
  <mat-tab-group class="reports-tabs" *ngIf="!isLoading">
    <!-- Reporte de Entregas -->
    <mat-tab label="Entregas">
      <ng-template matTabContent>
        <mat-card class="report-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>local_shipping</mat-icon>
              Reporte de Entregas
            </mat-card-title>
            <div class="card-actions">
              <button mat-icon-button (click)="exportToExcel('delivery')" matTooltip="Exportar a Excel">
                <mat-icon>file_download</mat-icon>
              </button>
              <button mat-icon-button (click)="printReport('delivery')" matTooltip="Imprimir">
                <mat-icon>print</mat-icon>
              </button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="table-container">
              <table mat-table [dataSource]="deliveryReports" class="delivery-table">
                <ng-container matColumnDef="employeeName">
                  <th mat-header-cell *matHeaderCellDef>Empleado</th>
                  <td mat-cell *matCellDef="let report">{{ report.employeeName }}</td>
                </ng-container>

                <ng-container matColumnDef="cedula">
                  <th mat-header-cell *matHeaderCellDef>Cédula</th>
                  <td mat-cell *matCellDef="let report">{{ report.cedula }}</td>
                </ng-container>

                <ng-container matColumnDef="zona">
                  <th mat-header-cell *matHeaderCellDef>Zona</th>
                  <td mat-cell *matCellDef="let report">{{ report.zona }}</td>
                </ng-container>

                <ng-container matColumnDef="elemento">
                  <th mat-header-cell *matHeaderCellDef>Artículo</th>
                  <td mat-cell *matCellDef="let report">{{ report.elemento | titlecase }}</td>
                </ng-container>

                <ng-container matColumnDef="cantidad">
                  <th mat-header-cell *matHeaderCellDef>Cantidad</th>
                  <td mat-cell *matCellDef="let report">{{ report.cantidad }}</td>
                </ng-container>

                <ng-container matColumnDef="fechaEntrega">
                  <th mat-header-cell *matHeaderCellDef>Fecha Entrega</th>
                  <td mat-cell *matCellDef="let report">{{ report.fechaEntrega | date:'dd/MM/yyyy' }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="deliveryColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: deliveryColumns;"></tr>
              </table>

              <div *ngIf="deliveryReports.length === 0" class="no-data">
                <mat-icon>inbox</mat-icon>
                <p>No se encontraron entregas con los filtros aplicados</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </ng-template>
    </mat-tab>

    <!-- Reporte de Inventario -->
    <mat-tab label="Inventario">
      <ng-template matTabContent>
        <mat-card class="report-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>inventory</mat-icon>
              Reporte de Inventario
            </mat-card-title>
            <div class="card-actions">
              <button mat-icon-button (click)="exportToExcel('inventory')" matTooltip="Exportar a Excel">
                <mat-icon>file_download</mat-icon>
              </button>
              <button mat-icon-button (click)="printReport('inventory')" matTooltip="Imprimir">
                <mat-icon>print</mat-icon>
              </button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="table-container">
              <table mat-table [dataSource]="inventoryReports" class="inventory-table">
                <ng-container matColumnDef="code">
                  <th mat-header-cell *matHeaderCellDef>Código</th>
                  <td mat-cell *matCellDef="let report">{{ report.code }}</td>
                </ng-container>

                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Artículo</th>
                  <td mat-cell *matCellDef="let report">{{ report.name | titlecase }}</td>
                </ng-container>

                <ng-container matColumnDef="category">
                  <th mat-header-cell *matHeaderCellDef>Categoría</th>
                  <td mat-cell *matCellDef="let report">{{ report.category | titlecase }}</td>
                </ng-container>

                <ng-container matColumnDef="currentStock">
                  <th mat-header-cell *matHeaderCellDef>Stock Actual</th>
                  <td mat-cell *matCellDef="let report">
                    <span [class]="'stock-' + report.status.toLowerCase()">
                      {{ report.currentStock }}
                    </span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="minimumStock">
                  <th mat-header-cell *matHeaderCellDef>Stock Mínimo</th>
                  <td mat-cell *matCellDef="let report">{{ report.minimumStock }}</td>
                </ng-container>

                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Estado</th>
                  <td mat-cell *matCellDef="let report">
                    <span class="status-badge" [ngClass]="'status-' + report.status.toLowerCase()">
                      <mat-icon>{{ report.status === 'OK' ? 'check_circle' : 
                                   report.status === 'LOW' ? 'warning' : 'error' }}</mat-icon>
                      {{ getStatusText(report.status) }}
                    </span>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="inventoryColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: inventoryColumns;"></tr>
              </table>

              <div *ngIf="inventoryReports.length === 0" class="no-data">
                <mat-icon>inbox</mat-icon>
                <p>No se encontraron artículos en el inventario</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </ng-template>
    </mat-tab>

    <!-- Reporte de Consumo -->
    <mat-tab label="Consumo por Zona">
      <ng-template matTabContent>
        <mat-card class="report-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>trending_up</mat-icon>
              Reporte de Consumo por Zona
            </mat-card-title>
            <div class="card-actions">
              <button mat-icon-button (click)="exportToExcel('consumption')" matTooltip="Exportar a Excel">
                <mat-icon>file_download</mat-icon>
              </button>
              <button mat-icon-button (click)="printReport('consumption')" matTooltip="Imprimir">
                <mat-icon>print</mat-icon>
              </button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="table-container">
              <table mat-table [dataSource]="consumptionReports" class="consumption-table">
                <ng-container matColumnDef="elemento">
                  <th mat-header-cell *matHeaderCellDef>Artículo</th>
                  <td mat-cell *matCellDef="let report">{{ report.elemento | titlecase }}</td>
                </ng-container>

                <ng-container matColumnDef="zona">
                  <th mat-header-cell *matHeaderCellDef>Zona</th>
                  <td mat-cell *matCellDef="let report">{{ report.zona }}</td>
                </ng-container>

                <ng-container matColumnDef="totalEntregado">
                  <th mat-header-cell *matHeaderCellDef>Total Entregado</th>
                  <td mat-cell *matCellDef="let report">
                    <strong>{{ report.totalEntregado }}</strong> unidades
                  </td>
                </ng-container>

                <ng-container matColumnDef="numeroEntregas">
                  <th mat-header-cell *matHeaderCellDef>N° Entregas</th>
                  <td mat-cell *matCellDef="let report">{{ report.numeroEntregas }}</td>
                </ng-container>

                <ng-container matColumnDef="promedioEntrega">
                  <th mat-header-cell *matHeaderCellDef>Promedio por Entrega</th>
                  <td mat-cell *matCellDef="let report">{{ report.promedioEntrega | number:'1.1-1' }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="consumptionColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: consumptionColumns;"></tr>
              </table>

              <div *ngIf="consumptionReports.length === 0" class="no-data">
                <mat-icon>inbox</mat-icon>
                <p>No se encontraron datos de consumo</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </ng-template>
    </mat-tab>
  </mat-tab-group>

  <!-- Loading spinner -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-progress-spinner mode="indeterminate" diameter="60"></mat-progress-spinner>
    <p>Cargando reportes...</p>
  </div>
</div>
