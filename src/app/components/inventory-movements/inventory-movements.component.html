<div class="movements-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>history</mat-icon>
        Historial de Movimientos de Inventario
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Filtros -->
      <div class="filters-section">
        <mat-form-field appearance="outline">
          <mat-label>Buscar</mat-label>
          <input 
            matInput 
            [(ngModel)]="searchText" 
            (ngModelChange)="applyFilters()"
            placeholder="Buscar por elemento o motivo...">
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Tipo de Movimiento</mat-label>
          <mat-select [(ngModel)]="selectedMovementType" (ngModelChange)="applyFilters()">
            <mat-option value="all">Todos</mat-option>
            <mat-option value="entrada">Entradas</mat-option>
            <mat-option value="salida">Salidas</mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-raised-button color="primary" (click)="clearFilters()">
          <mat-icon>clear</mat-icon>
          Limpiar Filtros
        </button>

        <button mat-raised-button (click)="loadMovements()">
          <mat-icon>refresh</mat-icon>
          Actualizar
        </button>
      </div>

      <!-- Loader -->
      <div *ngIf="isLoading" class="loading-container">
        <mat-spinner></mat-spinner>
        <p>Cargando movimientos...</p>
      </div>

      <!-- Tabla de Movimientos -->
      <div *ngIf="!isLoading" class="table-container">
        <table mat-table [dataSource]="dataSource" matSort class="movements-table">
          
          <!-- Fecha -->
          <ng-container matColumnDef="created_at">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha y Hora</th>
            <td mat-cell *matCellDef="let movement">
              {{ formatDate(movement.created_at) }}
            </td>
          </ng-container>

          <!-- Elemento -->
          <ng-container matColumnDef="supply_name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Elemento</th>
            <td mat-cell *matCellDef="let movement">
              <strong>{{ movement.supply_name }}</strong>
            </td>
          </ng-container>

          <!-- Tipo de Movimiento -->
          <ng-container matColumnDef="movement_type">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
            <td mat-cell *matCellDef="let movement">
              <mat-chip [color]="getMovementTypeColor(movement.movement_type)" selected>
                <mat-icon>{{ getMovementTypeIcon(movement.movement_type) }}</mat-icon>
                {{ movement.movement_type === 'entrada' ? 'ENTRADA' : 'SALIDA' }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Cantidad -->
          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Cantidad</th>
            <td mat-cell *matCellDef="let movement" class="quantity-cell">
              <span [class.positive]="movement.movement_type === 'entrada'"
                    [class.negative]="movement.movement_type === 'salida'">
                {{ movement.movement_type === 'entrada' ? '+' : '-' }}{{ movement.quantity }}
              </span>
            </td>
          </ng-container>

          <!-- Stock Anterior -->
          <ng-container matColumnDef="previous_quantity">
            <th mat-header-cell *matHeaderCellDef>Stock Anterior</th>
            <td mat-cell *matCellDef="let movement">
              {{ movement.previous_quantity }}
            </td>
          </ng-container>

          <!-- Stock Nuevo -->
          <ng-container matColumnDef="new_quantity">
            <th mat-header-cell *matHeaderCellDef>Stock Nuevo</th>
            <td mat-cell *matCellDef="let movement">
              <strong>{{ movement.new_quantity }}</strong>
            </td>
          </ng-container>

          <!-- Motivo -->
          <ng-container matColumnDef="reason">
            <th mat-header-cell *matHeaderCellDef>Motivo</th>
            <td mat-cell *matCellDef="let movement">
              {{ movement.reason || '-' }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

          <!-- Fila cuando no hay datos -->
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
              <mat-icon>inbox</mat-icon>
              <p>No se encontraron movimientos</p>
            </td>
          </tr>
        </table>
      </div>

      <!-- Resumen -->
      <div *ngIf="!isLoading && dataSource.data.length > 0" class="summary">
        <mat-icon>info</mat-icon>
        Mostrando <strong>{{ dataSource.data.length }}</strong> movimiento(s)
      </div>
    </mat-card-content>
  </mat-card>
</div>
